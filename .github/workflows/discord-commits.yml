name: Discord Commits

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Send commit to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          AUTHOR=$(git log -1 --pretty=format:"%an")
          SHA=$(git log -1 --pretty=format:"%H")
          SHORT_SHA=$(git log -1 --pretty=format:"%h")
          REPO=${{ github.repository }}

          # Build JSON payload safely
          read -r -d '' PAYLOAD << EOM
          {
            "embeds": [{
              "title": "ðŸ”¨ New Commit ($SHORT_SHA)",
              "description": "**$COMMIT_MSG**",
              "url": "https://github.com/$REPO/commit/$SHA",
              "color": 5814783,
              "footer": { "text": "Committed by $AUTHOR" }
            }]
          }
          EOM

          # Send to Discord
          curl -H "Content-Type: application/json" -d "$PAYLOAD" $DISCORD_WEBHOOK
