name: Discord Stable Release Notify

on:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Send release to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          RELEASE_JSON: ${{ toJson(github.event.release) }}
          ACTOR: ${{ github.actor }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "DISCORD_WEBHOOK secret is missing"
            exit 1
          fi

          PRERELEASE=$(echo "$RELEASE_JSON" | jq -r '.prerelease')

          # Skip prereleases entirely
          if [ "$PRERELEASE" = "true" ]; then
            echo "Prerelease detected â€” skipping Discord notification."
            exit 0
          fi

          TAG_NAME=$(echo "$RELEASE_JSON" | jq -r '.tag_name')
          RELEASE_BODY=$(echo "$RELEASE_JSON" | jq -r '.body // empty')
          RELEASE_URL=$(echo "$RELEASE_JSON" | jq -r '.html_url')

          if [ -z "$RELEASE_BODY" ]; then
            RELEASE_BODY="A new stable version of SpectraUI is now available."
          fi

          # Discord embed description limit
          RELEASE_BODY="${RELEASE_BODY:0:4000}"

          jq -n \
            --arg title "âœ¨ New Stable Release: $TAG_NAME" \
            --arg body "$RELEASE_BODY" \
            --arg url "$RELEASE_URL" \
            --arg actor "$ACTOR" \
            '{
              embeds: [{
                title: $title,
                description: $body,
                url: $url,
                color: 2799359,
                fields: [
                  {
                    name: "ðŸ“¦ Downloads",
                    value: "[CurseForge](https://www.curseforge.com/wow/addons/spectraui)\n[Wago](https://addons.wago.io/addons/spectraui)",
                    inline: false
                  }
                ],
                footer: {
                  text: "Released by " + $actor
                }
              }]
            }' | curl -X POST \
              -H "Content-Type: application/json" \
              -d @- \
              "$DISCORD_WEBHOOK"
