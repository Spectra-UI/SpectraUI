name: Discord Releases

on:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send release to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          RELEASE_NAME="${{ github.event.release.name }}"
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          RELEASE_BODY="${{ github.event.release.body }}"
          AUTHOR="${{ github.event.release.author.login }}"
          URL="${{ github.event.release.html_url }}"

          # Safe JSON creation
          JSON_PAYLOAD=$(jq -n \
            --arg name "$RELEASE_NAME" \
            --arg body "$RELEASE_BODY" \
            --arg url "$URL" \
            --arg author "$AUTHOR" \
            --arg tag "$RELEASE_TAG" \
            '{
              embeds: [{
                title: "New Stable Build: " + $name,
                description: $body,
                url: $url,
                color: 5814783,
                footer: { text: "Published by " + $author + " | Tag: " + $tag }
              }]
            }')

          curl -H "Content-Type: application/json" \
               -d "$JSON_PAYLOAD" \
               $DISCORD_WEBHOOK
